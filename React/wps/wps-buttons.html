<html>
    <head>
        <title>WPS Form Buttons</title>

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <!-- Point to your own jquery -->
        <script src="../../jquery-3.1.1.js"></script>
        <script src="https://unpkg.com/react@latest/dist/react.js"></script>
        <script src="https://unpkg.com/react-dom@latest/dist/react-dom.js"></script>
        <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    </head>
    <body>
        <h1>WPS Form Buttons</h1>
        <br>
        <div id="wpsbuttons"></div>

        <script type="text/babel">
         var WpsButtons = React.createClass({
             getInitialState: function() {
                 return {
                     input: '',
                     stage: 'msmaster',
                     buttons: [
                         {
                             button_name: 'Buy Now Item',
                             button_details: 'Simple buy now item',
                             button_description: 'Minimal params and multiple amounts',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Item',
                                 amount: [ '1.11', '2.22', '3.33' ] // result should be the last value
                             }
                         },
                         {
                             button_name: 'Buy Now - fr_FR',
                             button_details: 'Buy now item with locale',
                             button_description: 'fr_FR locale with simple button',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 lc: 'fr_FR',
                                 item_name: 'Myke fr_FR Item',
                                 amount: '3.33'
                             }
                         },
                         {
                             button_name: 'Buy Now - es_ES',
                             button_details: 'Buy now item with locale',
                             button_description: 'es_ES locale with simple button',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 lc: 'es_ES',
                                 item_name: 'Myke es_ES Item',
                                 amount: '3.33'
                             }
                         },
                         {
                             button_name: 'Buy Now Item - Discount',
                             button_details: 'Buy now with discount amount',
                             button_description: 'Discount should be subtracted from total',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Discounted Item',
                                 amount: '10.00',
                                 discount_amount: '4'
                             }
                         },
                         {
                             button_name: 'Cart Upload',
                             button_details: 'Three item cart',
                             button_description: 'Three items with item_numbers and ampersands',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_cart',
                                 upload: '1',
                                 item_name_1: 'Myke Item #1 & extras',
                                 item_number_1: '1234-1',
                                 amount_1: '1.11',
                                 item_name_2: 'Myke Item #2 & extras',
                                 item_number_2: '1234-2',
                                 amount_2: '2.22',
                                 item_name_3: 'Myke Item #3 & bonus stuff',
                                 amount_3: '3.33',
                                 item_number_3: '1234-3'
                             }
                         },
                         {
                             button_name: 'Open Button - amount',
                             button_details: 'amount is missing',
                             button_description: 'User allowed to enter amount',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Pick Your Amount Item',
                             }
                         },
                         {
                             button_name: 'Open Button - amount',
                             button_details: 'Two amount params, second is empty',
                             button_description: 'User allowed to enter amount (default set to first value)',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Pick Your Amount Item',
                                 amount: [ '10.00', '' ]
                             }
                         },
                         {
                             button_name: 'Open Button - name',
                             button_details: 'name is missing',
                             button_description: 'User allowed to enter item name',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 amount: '10.00'
                             }
                         },
                         {
                             button_name: 'Open Button - name',
                             button_details: 'Two name params, second is empty',
                             button_description: 'User allowed to enter item name (default set to first value)',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 amount: '10.00',
                                 item_name: [ 'default name', '' ]
                             }
                         },
                         {
                             button_name: 'Open Button - quantity',
                             button_details: 'undefined_quantity set',
                             button_description: 'Initial quantity is 2, user allowed to change',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Specify Your Quantity Item',
                                 amount: '1.11',
                                 quantity: '2',
                                 undefined_quantity: '1'
                             }
                         },
                         {
                             button_name: 'Buy Now with return URL',
                             button_details: 'Simple item with only return URL',
                             button_description: 'return URL by itself is NOT present in cart but in AppData',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Item',
                                 return: 'http://hermes-test-tool-9913.ccg21.dev.paypalcorp.com/wps?return_reason=payment_complete',
                                 amount: '1.11'
                             }
                         },
                         {
                             button_name: 'Buy Now with cancel URL',
                             button_details: 'Simple item with only cancel URL',
                             button_description: 'cancel URL by itself IS present in cart and in AppData',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Item',
                                 cancel_return: 'http://hermes-test-tool-9913.ccg21.dev.paypalcorp.com/wps?return_reason=payment_cancelled',
                                 amount: '1.11'
                             }
                         },
                         {
                             button_name: 'Buy Now with both URLs',
                             button_details: 'Simple item with return and cancel URL',
                             button_description: 'return and cancel URLs both present in cart and AppData',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Item',
                                 return: 'http://hermes-test-tool-9913.ccg21.dev.paypalcorp.com/wps?return_reason=payment_complete',
                                 cancel_return: 'http://hermes-test-tool-9913.ccg21.dev.paypalcorp.com/wps?return_reason=payment_cancelled',
                                 amount: '1.11'
                             }
                         },
                         {
                             button_name: 'Buy Now with all the Things',
                             button_details: 'Many different WPS parameters',
                             button_description: 'The One Ring with many parameters and options to show on mini cart',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'The One Ring',
                                 return: 'http://hermes-test-tool-9913.ccg21.dev.paypalcorp.com/wps?return_reason=payment_complete',
                                 cancel_return: 'http://hermes-test-tool-9913.ccg21.dev.paypalcorp.com/wps?return_reason=payment_cancelled',
                                 amount: '1.11',
                                 discount_amount: '0.12',
                                 tax: '0.22',
                                 handling: '2.33',
                                 shipping: '0.55',
                                 on0: 'Size',
                                 os0: 'Large',
                                 on1: 'Stone',
                                 os1: 'Diamond',
                                 on2: 'Metal',
                                 os2: 'Platinum',
                                 on3: 'Setting',
                                 os3: 'Princess'
                             }
                         },
                         {
                             button_name: 'Buy Now - Guest Names',
                             button_details: 'Buy now with first and last names and address',
                             button_description: 'First and last names should be populated in guest',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Test Item',
                                 amount: '1.11',
                                 first_name: 'Frodo',
                                 last_name: 'Baggins',
                                 landing_page: 'billing',
                                 address1: '2211 N First St',
                                 city: 'San Jose',
                                 state: 'CA',
                                 zip: '95131'
                             }
                         },
                         {
                             button_name: 'Zip With Spaces',
                             button_details: 'Address with spaces in zip',
                             button_description: 'Spaces should be honored in zip',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Myke Test Address Item',
                                 charset: 'utf-8',
                                 amount: '1.11',
                                 first_name: 'Frodo',
                                 last_name: 'Baggins',
                                 landing_page: 'billing',
                                 address1: '1 Rose Cottage The Common',
                                 address2: 'East Hanningfield',
                                 city: 'Chelmsford',
                                 country: 'GB',
                                 zip: 'CM3 8AH'
                             }
                         },
                         {
                             button_name: 'Option Select but no name',
                             button_details: 'Pricing selection without a name',
                             button_description: 'Amount should be calculated when os0 but no on0 present',
                             button_params: {
                                 business: 'qa155-seller@paypal.com',
                                 cmd: '_xclick',
                                 item_name: 'Pricing option but no name',
                                 os0: 'Large',
                                 option_select0: 'Small',
                                 option_amount0: '1.11',
                                 option_select1: 'Medium',
                                 option_amount1: '22.22',
                                 option_select2: 'Large',
                                 option_amount2: '333.33',
                                 on1: 'Stone',
                                 os1: 'Diamond',
                                 on2: 'Metal',
                                 os2: 'Platinum',
                                 on3: 'Setting',
                                 os3: 'Princess'
                             }
                         },
                     ]
                 };
             },
             // I guess "set the stage" should be it's own React component.
             // Which then feeds into the "list of buttons" component.
             handleSetStage: function(event) {
                 console.log(`Handle Set Stage button click.`);
                 this.setStage();
             },
             handleStageInput: function(event) {
                 // Calling setState() here of course means also do a render().
                 // Which means all the buttons are being regenerated on every key press in the text box!
                 // this.setState({ input: event.target.value });

                 // Instead, just set the value in state directly (no setState()) so no re-render happens.
                 // Is this, like, against React religion?
                 // Components do have a shouldComponentUpdate() method that can be overridden.
                 // But this also shows how we really should be breaking this page into multiple
                 // components instead of having everything in a single one.
                 this.state.input = event.target.value;
             },
             interceptEnter: function(event) {
                 if (event.which === 13) {
                     console.log(`Handling <Enter> key press`);
                     this.setStage();
                 }
             },
             setStage: function() {
                 console.info(`Handling setting the stage to: [${this.state.input.toLowerCase()}]`);
                 // XXX/mm do some sort of validation?
                 // Also, here might be a spot to change a 'business' param on a per-stage basis?
                 this.setState({ stage: this.state.input.toLowerCase() });
             },
             // Build the form inputs for the WPS form. Returns an array of one (or more) of these lines:
             //    <input name="amount"  value="25.00"type="hidden" />
             // For each parameter in button_params.
             buildFormInputs: function(button_params) {
                 console.groupCollapsed(`Building form input from parameters`);
                 let form_inputs = [],
                     pnum = 1;
                 for (let param in button_params) {
                     const pvalue = button_params[param];
                     // For a non-array could push that single value onto an array and always use the array loop?
                     // Is that too clever?
                     if (Array.isArray(pvalue)) {
                         console.log(`  Found an array of values. Adding multiple inputs`);
                         pvalue.map((next_value) => {
                             console.log(`  Form array input  #${pnum}: ${param} = ${next_value}`);
                             form_inputs.push (
                                 <input key={pnum++} name={param} value={next_value} type="hidden" />
                             );
                         });
                     } else {
                         console.log(`  Form single input #${pnum}: ${param} = ${button_params[param]}`);
                         form_inputs.push (
                             <input key={pnum++} name={param} value={button_params[param]} type="hidden" />
                         );
                     }
                 }
                 console.groupEnd(`Building form input from parameters`);
                 return form_inputs;
             },
             buildStageButton: function(button, idx) {
                 console.log(`Building button '${button.button_name}' at idx ${idx}`);
                 let url;
                 if (this.state.stage.toLowerCase() === 'localhost') {
                     url = `http://${this.state.stage}.qa.paypal.com:8000/cgi-bin/webscr`;
                 } else if (this.state.stage.toLowerCase() === 'live') {
                     url = `https://www.paypal.com/cgi-bin/webscr`;
                 } else if (this.state.stage.toLowerCase() === 'sandbox') {
                     url = `https://www.sandbox.paypal.com/cgi-bin/webscr`;
                 } else {
                     url = `https://www.${this.state.stage}.qa.paypal.com/cgi-bin/webscr`;
                 }
                 let name = button.button_name;
                 // Note every JSX object in an array or iterator of them must have a unique "key".
                 // So add that the top level tag here in case it ends up in an array (which it does).
                 return (
                     <tr key={idx}>
                         <td>
                             <form action={url} method="post" target="wps">
                                 {this.buildFormInputs(button.button_params)}
                                 <input value={name} type="submit" />
                             </form>
                         </td>
                         <td>
                             {button.button_details}
                         </td>
                         <td>
                             {button.button_description}
                         </td>
                     </tr>
                 );
             },

             // Build the area displaying all the buttons and their descriptions.
             buildAllButtons: function() {
                 console.group(`Building ${this.state.buttons.length} total buttons:`);
                 console.table(this.state.buttons);
                 let button_rows = this.state.buttons.map((button, idx) => {
                     return this.buildStageButton(button, idx);
                 });
                 console.log(`Built ${button_rows.length} button rows`);
                 console.groupEnd(`Building ${this.state.buttons.length} total buttons:`);
                 return (
                     <table className="table-striped">
                         <thead>
                             <tr>
                                 <td>WPS Button</td>
                                 <td>Details</td>
                                 <td>Full Description</td>
                             </tr>
                         </thead>
                         <tbody>
                             {button_rows}
                         </tbody>
                     </table>
                 );
             },

             // Build the area for inputting a new stage to point to.
             buildStageInputArea: function() {
                 let areaClass = "container bg-info";
                 if (this.state.stage === 'live') {
                     console.log(`Using LIVE danger background`);
                     areaClass = "container bg-danger";
                 }
                 return (
                     <div className={areaClass}>
                         <br/>
                         <div className="row">
                             <div className="col-sm-2 col-md-1">
                                 <button className="btn btn-default"
                                         onClick={this.handleSetStage}>Set Stage</button>
                             </div>
                             <div className="col-sm-10 col-md-11">
                                 <input className="form-control"
                                        maxLength="50" placeholder="enter stage name"
                                        onChange={this.handleStageInput}
                                        onKeyPress={this.interceptEnter} />
                             </div>
                         </div>
                         <div className="row">
                             <div className="col-sm-12">
                                 Current Stage: <strong className="text-success">{this.state.stage}</strong>
                             </div>
                         </div>
                         <br/>
                     </div>
                 );
             },

             render: function () {
                 return (
                     <div className="well clearfix">
                         {this.buildStageInputArea()}
                         <br/>
                         {this.buildAllButtons()}
                     </div>
                 );
             }
         });

         ReactDOM.render(
             <WpsButtons />,
             document.getElementById("wpsbuttons")
         );
        </script>

    </body>
</html>
